<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>聊天室</title>
    <script charset="utf-8" type="text/javascript" src="/jquery/2.1.4/jquery.min.js"></script>
    <script charset="utf-8" type="text/javascript" src="/jquery-ui/1.13.1/jquery-ui.js"></script>
    <script charset="utf-8" type="text/javascript" src="/js/com.wxd.js"></script>

    <link rel="stylesheet" type="text/css" href="/style/com.wxd.css"/>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {overflow: hidden;width: 100%;height: 100%;}

        .chat-content {
            margin-top: 10px;
        }

        .chat-content p {
            margin-top: 10px;
            text-wrap: auto;
            word-break: break-all;
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            *white-space: normal !important;
            letter-spacing: 2px; /* 增加字符间距 */
        }
    </style>
    <script>
        var pingMessage = new wxd.Map().put("cmd", "ping").toJson();
        var wsClient = new wxd.netty.WSClient();
        let ws_url = "";
        let loginEnd = false;


        $(() => {
            if (window.location.protocol.toLowerCase() === "https:") {
                ws_url = "wss";
            } else {
                ws_url = "ws";
            }
            var host = window.location.host;
            if (host.indexOf(":") > 0) {
                host = host.substring(0, host.indexOf(":"));
            }
            ws_url = ws_url + "://" + host + ":18001/wxd-chat";
            console.log("ws_url=" + ws_url);
            wsClient.onRead = (data) => {
                var msg = JSON.parse(data);
                if (msg.code !== 1) {
                    wxd.message.notice(msg.error);
                    return;
                }
                if (msg.cmd === "ping") {

                } else if (msg.cmd === "logined") {
                    for (const msgElement of msg.history) {
                        addChatContent(msgElement);
                    }
                    let newSpit = {};
                    newSpit.nick = "";
                    newSpit.time = "";
                    newSpit.address = "";
                    newSpit.content = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-----------------------------------------------------新消息-----------------------------------------------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
                    addChatContent(newSpit);
                    loginEnd = true;
                } else if (msg.cmd === "login") {
                    wxd.message.notice("欢迎 " + msg.nick + " 进入聊天室");
                } else {
                    addChatContent(msg);
                }
            };

            wsClient.onClose = () => {
                wxd.message.alert("连接异常，点击确认后重连！", "提示", "确认", () => {
                    wsClient.connect(ws_url);
                });
            };

            wsClient.connect(ws_url);

            setInterval(function () {
                if (wsClient.socketOpen) {
                    wsClient.sendMsg(pingMessage);
                }
            }, 2000);

            var item = localStorage.getItem("chat-nick-name");
            if (wxd.isNull(item)) {
                $("#nick-input").val("匿名");
            } else {
                $("#nick-input").val(item);
            }

        });

        function addChatContent(msg) {
            if (msg.cmd === "chat-img") {
                msg.content = `<object data="${msg.content}" style="max-width: 90%;max-height: 280px;"></object>`;
            }
            let content = `
                    <div class="chat-content">
                        <p>${msg.nick} ${msg.time} ${msg.address}</p>
                        <p>${msg.content}</p>
                    </div>
                `;
            $("#chat-box").append(content);
            $("#chat-box").scrollTop($("#chat-box").scrollTop() + 500);
        }

        function login() {
            var value = $("#nick-input").val();
            if (wxd.isNull(value)) {
                wxd.message.notice("昵称不能为空");
                return;
            }
            if (value.length > 18) {
                wxd.message.notice("昵称不能超过18个字符");
                return;
            }
            localStorage.setItem("chat-nick-name", value);
            wsClient.sendMsg(new wxd.Map().put("cmd", "login").put("nick", value).toJson());
        }

        function sendChat() {
            if (!wsClient.socketOpen) {
                wxd.message.notice("socket 异常");
                return;
            }
            if (!loginEnd) {
                wxd.message.notice("未登录");
                return;
            }
            var content = $("#chat-input").val();
            if (wxd.isNull(content)) {
                return;
            }
            if (content.length > 398) {
                wxd.message.notice("内容太多");
                return;
            }
            wsClient.sendMsg(new wxd.Map().put("cmd", "chat").put("content", content).toJson());
        }

        function sendImg() {
            wxd.netty.upload("/chat/upload", null, function (data) {
                if (data.code !== 1) {
                    wxd.message.notice(data.error);
                    return;
                }
                wsClient.sendMsg(new wxd.Map().put("cmd", "chat-img").put("content", data.data).toJson());
            });
        }
    </script>
</head>
<body>
<div>
    <div id="chat-title" style="width: 160px;position: absolute;left: 0;top:0;bottom: 0;">
        公共聊天室
        <input id="nick-input" style="width: calc(100% - 5px);" value="匿名">
        <button id="login-btn" style="width: calc(100% - 5px);height: 30px;" onclick="login()">登录</button>
    </div>
    <div id="chat-box" style="position: absolute;left: 161px;top:0;right: 2px; bottom: 120px;overflow-y: scroll;">
        <div class="chat-content" style="">
            <p>無心道 2024-11-27 20:20:20 浙江.杭州</p>
            <p>ccccccc</p>
        </div>
    </div>
    <div style="position: absolute;left: 161px;right: 0; bottom: 0;height: 120px;align-items: center;justify-content: center;display: flex;">
        <textarea id="chat-input" style="width: calc(100% - 150px);height: calc(100% - 15px);"></textarea>
        <button id="chat-send" style="height: calc(100% - 15px);width: 50px;margin-left: 5px;" onclick="sendChat()">
            发送
        </button>
        <button id="chat-img-send" style="height: calc(100% - 15px);width: 50px;margin-left: 5px;" onclick="sendImg()">
            文件
        </button>
    </div>
</div>
<!--<div id="login_bg" style="position: absolute;left: 0;top:0;right: 0; bottom: 0;">-->

<!--</div>-->
</body>
</html>